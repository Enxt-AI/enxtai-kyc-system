generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid())
  email           String          @unique
  phone           String          @unique
  kycStatus       KYCStatus       @default(PENDING)
  cvlKraId        String?         @unique
  cvlKraStatus    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  kycSubmissions  KYCSubmission[]
  auditLogs       AuditLog[]

  @@map("users")
}

model KYCSubmission {
  id                      String          @id @default(uuid())
  userId                  String
  submissionDate          DateTime        @default(now())

  // Document source
  documentSource          DocumentSource

  // Document URLs (MinIO paths - encrypted)
  panDocumentUrl          String?
  aadhaarDocumentUrl      String?  // Keep for backward compatibility
  aadhaarFrontUrl         String?  // NEW: Front side with photo
  aadhaarBackUrl          String?  // NEW: Back side with address
  livePhotoUrl            String?

  // Extracted data
  panNumber               String?
  aadhaarNumber           String?         // Masked (last 4 digits only)
  fullName                String?
  dateOfBirth             DateTime?
  address                 Json?

  // OCR results
  ocrResults              Json?

  // Face verification results
  faceMatchScore          Float?
  livenessScore           Float?
  faceExtractionSuccess   Boolean         @default(false)

  // CVL KRA integration
  cvlKraSubmitted         Boolean         @default(false)
  cvlKraSubmissionDate    DateTime?
  cvlKraResponse          Json?
  cvlKraStatus            String?

  // Status
  internalStatus          InternalStatus  @default(PENDING)
  finalStatus             FinalStatus     @default(INCOMPLETE)
  rejectionReason         String?

  // Timestamps
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([panNumber])
  @@index([internalStatus])
  @@index([finalStatus])
  @@map("kyc_submissions")
}

model AuditLog {
  id          String    @id @default(uuid())
  userId      String?
  action      String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime  @default(now())

  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

enum KYCStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  CVL_SUBMITTED
  CVL_VALIDATED
  REJECTED
}

enum DocumentSource {
  MANUAL_UPLOAD
  DIGILOCKER
}

enum InternalStatus {
  PENDING
  DOCUMENTS_UPLOADED
  OCR_COMPLETED
  FACE_VERIFIED
  VERIFIED
  REJECTED
  PENDING_REVIEW
}

enum FinalStatus {
  INCOMPLETE
  COMPLETE
  REJECTED
}
